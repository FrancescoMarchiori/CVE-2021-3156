# üõ°Ô∏è Patching the Vulnerability

Nowadays, the sudo CVE-2021-3156 vulnerability has been patched since the version [1.9.5p2](https://github.com/sudo-project/sudo/releases/tag/SUDO_1_9_5p2). Considering all that we have presented and discussed about this vulnerability, we can understand that there are two possible approaches for fixing the vulnerability flow. We can either act on how the vulnerability is reached, or on the vulnerability itself.

## ‚õî Patching the vulnerability flow

The idea is not to modify the source code of `set_cmnd()` but acting on the conditions that make it possible to reach it without passing through `parse_args`.

> When invoked as sudoedit, the same set of command line options are now accepted as for sudo -e. The -H and -P options are now rejected for sudoedit and sudo -e, which matches the sudo 1.7 behavior. This is part of the fix for CVE-2021-3156. Fixed a potential buffer overflow when unescaping backslashes in the command's arguments. Normally, sudo escapes special characters when running a command via a shell (sudo -s or sudo -i). However, it was also possible to run sudoedit with the -s or -i flags in which case no escaping had actually been done, making a buffer overflow possible. This fixes CVE-2021-3156.

## ü©π Patching the code

Our proposal is based on checking how many characters are copied into the heap with respect to the number of characters that the corresponding command-line argument contains. We tried to introduce just the modifications that were strictly necessary to fix the vulnerability, they are highlighted by the ‚Äùpart of patch‚Äù comment, while the ‚Äùadded for simulation‚Äù comment indicates a line that is added just for the sake of the simulation but that are not necessary to the scope of the function.